<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating a Custom Function to Calculate Indices • eemanalyzeR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating a Custom Function to Calculate Indices">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">eemanalyzeR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Introduction to eemanalyzeR</a></li>
    <li><a class="dropdown-item" href="../articles/output-documentation.html">Interpreting eemanalyzeR Outputs</a></li>
    <li><a class="dropdown-item" href="../articles/eemanalyzeR-indices.html">Calculating Indices with eemanalyzeR Method</a></li>
    <li><a class="dropdown-item" href="../articles/custom-indices.html">Creating a Custom Function to Calculate Indices</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/katiewampler/eemanalyzeR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Creating a Custom Function to Calculate Indices</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/katiewampler/eemanalyzeR/blob/master/vignettes/custom-indices.Rmd" class="external-link"><code>vignettes/custom-indices.Rmd</code></a></small>
      <div class="d-none name"><code>custom-indices.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>To maximum flexibility in calculating indices, we’ve enabled the
<code><a href="../reference/get_indices.html">get_indices()</a></code> function to accept custom written functions,
allowing users to create their own function and calculate indices that
may not be included in existing methods.</p>
</div>
<div class="section level2">
<h2 id="function-requirements">Function Requirements<a class="anchor" aria-label="anchor" href="#function-requirements"></a>
</h2>
<ol style="list-style-type: decimal">
<li>
<strong>The function needs to have the following arguments:</strong>
<ol style="list-style-type: lower-alpha">
<li>
<code>eemlist</code>: an eemlist object containing EEM’s data.</li>
<li>
<code>abslist</code>: an abslist object containing absorbance
data.</li>
<li>
<code>cuvle</code>: the cuvette (path) length in cm.</li>
<li>
<code>qaqc_dir</code>: the file path to the mdl files generated with
<code><a href="../reference/create_mdl.html">create_mdl()</a></code>
</li>
</ol>
</li>
<li>
<strong>The function must return a list with the following
items:</strong>
<ol style="list-style-type: lower-alpha">
<li>
<code>abs_index</code>: the indices calculated from the absorbance
data</li>
<li>
<code>eem_index</code>: the indices calculated from the EEMs
data</li>
</ol>
</li>
</ol>
<p><code>abs_index</code> and <code>eem_index</code> should both be a
data.frame with the following columns:</p>
<ul>
<li><p><code>sample_name</code>: a character, the name of the
sample</p></li>
<li><p><code>meta_name</code>: a character, the name of the sample in
the metadata if metadata has been added, otherwise the sample name
again</p></li>
<li><p><code>index</code>: a character, the name of the index being
reported</p></li>
<li><p><code>value</code>: the value of the index, also accepts flag
values (see details below)</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="helper-functions">Helper Functions<a class="anchor" aria-label="anchor" href="#helper-functions"></a>
</h2>
<p><strong>The eemanalyzeR package contains a number of functions
helpful in creating custom indices.</strong></p>
<p>To get the absorbance values at a certain wavelength the
<code><a href="../reference/get_absorbance.html">get_absorbance()</a></code> function can be used. This function can
additionally provide specific absorbance (like SUVA 254).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abslist</span> <span class="op">&lt;-</span> <span class="va">example_processed_abs</span></span>
<span></span>
<span><span class="co">#absorbance at 254 nm</span></span>
<span><span class="va">a254</span> <span class="op">&lt;-</span> <span class="fu">eemanalyzeR</span><span class="fu">::</span><span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="fl">254</span><span class="op">)</span> </span>
<span><span class="va">a254</span> </span>
<span><span class="co">#&gt; [1] "0.00054853647738303" "0.163215306070913"   "0.0806502356009794" </span></span>
<span><span class="co">#&gt; [4] "0.300921250392953"</span></span>
<span></span>
<span><span class="co">#specific absorbance at 254 nm</span></span>
<span><span class="va">suva254</span> <span class="op">&lt;-</span> <span class="fu">eemanalyzeR</span><span class="fu">::</span><span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="fl">254</span>, suva<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="va">suva254</span></span>
<span><span class="co">#&gt; [1] "DOC01"            "DOC01"            "4.15722863922574" "DOC01"</span></span></code></pre></div>
<p>A similar function exists for getting fluorescence values from EEMs
data: <code><a href="../reference/get_fluorescence.html">get_fluorescence()</a></code>. Here, you can specify a range of
excitation and/or emission wavelengths. If stat is set to
<code>sum</code> the sum of fluorescence will be returned, otherwise if
<code>max</code> is used the maximum fluorescence across that range will
be returned.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">eemlist</span> <span class="op">&lt;-</span> <span class="va">example_processed_eems</span></span>
<span></span>
<span><span class="co">#get maximum fluorescence across ranges for Peak A and D</span></span>
<span><span class="va">pA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">250</span><span class="op">:</span><span class="fl">260</span>, em<span class="op">=</span><span class="fl">380</span><span class="op">:</span><span class="fl">480</span>, stat<span class="op">=</span><span class="st">"max"</span><span class="op">)</span></span>
<span><span class="va">pA</span></span>
<span><span class="co">#&gt; [1] "0.0103767473213219" "0.280569719363857"  "0.340345670357128" </span></span>
<span><span class="co">#&gt; [4] "0.721431003125204"</span></span>
<span><span class="va">pD</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">390</span>, em<span class="op">=</span><span class="fl">509</span>, stat<span class="op">=</span><span class="st">"max"</span><span class="op">)</span></span>
<span><span class="va">pD</span> </span>
<span><span class="co">#&gt; [1] "0.000304395508989419" "0.0199829245761789"   "0.0978435434033764"  </span></span>
<span><span class="co">#&gt; [4] "0.0372706531424358"</span></span>
<span></span>
<span><span class="co">#get sum of fluorescence across range of Peak A</span></span>
<span><span class="va">pA_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">250</span><span class="op">:</span><span class="fl">260</span>, em<span class="op">=</span><span class="fl">380</span><span class="op">:</span><span class="fl">480</span>, stat<span class="op">=</span><span class="st">"sum"</span><span class="op">)</span></span>
<span><span class="va">pA_sum</span></span>
<span><span class="co">#&gt; [1] "0.398846395176868" "15.4652173718784"  "29.1296537896885" </span></span>
<span><span class="co">#&gt; [4] "34.0595693438647"</span></span></code></pre></div>
<p>Lastly, we have a function for getting spectral slopes:
<code><a href="../reference/get_abs_slope.html">get_abs_slope()</a></code> which will convert the absorbance to
absorption, interpolate the data if needed, and return the spectral
slope within a wavelength range.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S275_295</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_abs_slope.html">get_abs_slope</a></span><span class="op">(</span><span class="va">abslist</span>, lim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span>,<span class="fl">295</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="qaqc-flags">QA/QC Flags<a class="anchor" aria-label="anchor" href="#qaqc-flags"></a>
</h2>
<p>While the <code><a href="../reference/get_indices.html">get_indices()</a></code> function includes some QA/QC
checks (negative numbers, missing values, below noise, outside expected
range, etc.), there are some checks that are easier to do when
calculating the indices, or you may wish to include custom flags or
checks. To pass flags from your index function to the output, they need
to get put in the <code>value</code> column of the index
data.frames.</p>
<p>There are a few rules to follow with flags:</p>
<ol style="list-style-type: decimal">
<li><p>Flags should have the form text## (DOC01, DATA04, etc.)</p></li>
<li><p>If an index value is NA and you want to flag with a reason why it
is NA, replace the NA value with that flag value.</p></li>
<li><p>If you wish to report a value, but still include a flag, report
the value in the form: value_flag (0.042_DATA01, 43.1_DOC01,
etc.)</p></li>
</ol>
<div class="section level3">
<h3 id="helper-functions-1">Helper Functions<a class="anchor" aria-label="anchor" href="#helper-functions-1"></a>
</h3>
<p>There are few helper functions within the
<strong>eemanalyzeR</strong> package that will provide some common
flags.</p>
<p>First is the <code><a href="../reference/get_ratios.html">get_ratios()</a></code> function. This can be helpful
when calculating things like peak ratios, where a missing value will
result in an <code>NA</code> or a value of 0 in the denominator will
result in an infinite value.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#calculate the ratio of Peak A to Peak T</span></span>
<span> <span class="va">pA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">250</span><span class="op">:</span><span class="fl">260</span>, em<span class="op">=</span><span class="fl">380</span><span class="op">:</span><span class="fl">480</span><span class="op">)</span></span>
<span> <span class="va">pT</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">270</span><span class="op">:</span><span class="fl">280</span>, em<span class="op">=</span><span class="fl">320</span><span class="op">:</span><span class="fl">350</span><span class="op">)</span></span>
<span> <span class="va">rAT</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="va">pA</span>, <span class="va">pT</span><span class="op">)</span></span>
<span> <span class="va">rAT</span></span>
<span><span class="co">#&gt; [1] "1.72750162152655"  "0.423565751341601" "4.07129094367473" </span></span>
<span><span class="co">#&gt; [4] "0.450601408727671"</span></span>
<span> </span>
<span>  <span class="co">#if Peak T is all 0, will return DATA_03 flag, indicating index couldn't </span></span>
<span>    <span class="co">#calculated due to zero in denominator</span></span>
<span>    <span class="va">rAT</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="va">pA</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">rAT</span></span>
<span><span class="co">#&gt; [1] "DATA03" "DATA03" "DATA03" "DATA03"</span></span>
<span> </span>
<span><span class="co">#calculate HIX </span></span>
<span>  <span class="va">sum_high</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">254</span>, em<span class="op">=</span><span class="fl">435</span><span class="op">:</span><span class="fl">480</span>, stat <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span></span>
<span>  <span class="va">sum_low</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">254</span>, em<span class="op">=</span><span class="fl">300</span><span class="op">:</span><span class="fl">345</span>, stat<span class="op">=</span><span class="st">"sum"</span><span class="op">)</span></span>
<span>  <span class="va">HIX</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="va">sum_high</span>,<span class="va">sum_low</span><span class="op">)</span></span>
<span>  <span class="va">HIX</span></span>
<span><span class="co">#&gt; [1] "DATA01" "DATA01" "DATA01" "DATA01"</span></span>
<span>  </span>
<span>  <span class="co">#if sum_low is NA, will return DATA_01 flag indicating the index couldn't be </span></span>
<span>    <span class="co">#calculated due to missing data</span></span>
<span>    <span class="va">HIX</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="va">sum_high</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="va">HIX</span></span>
<span><span class="co">#&gt; [1] "DATA01" "DATA01" "DATA01" "DATA01"</span></span></code></pre></div>
<p>There’s also a function that will flag indices that can’t be
calculated because data didn’t exist for the requested wavelengths:
<code><a href="../reference/flag_missing.html">flag_missing()</a></code>. This is useful to check when calculating
indices to flag why certain indices might be returning <code>NA</code>
values.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#checking absorbance data</span></span>
<span>  <span class="co">#data exists, so there are no flags, NA is returned</span></span>
<span>  <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="fl">400</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] NA NA NA NA</span></span>
<span></span>
<span> <span class="co">#data doesn't exist</span></span>
<span>  <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DATA01" "DATA01" "DATA01" "DATA01"</span></span>
<span>  </span>
<span> <span class="co">#some data exists, still calculate</span></span>
<span>  <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="fl">100</span><span class="op">:</span><span class="fl">254</span>, all<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DATA02" "DATA02" "DATA02" "DATA02"</span></span>
<span></span>
<span><span class="co">#checking fluorescence data</span></span>
<span>  <span class="co">#data exists, so there are no flags, NA is returned</span></span>
<span>  <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">270</span><span class="op">:</span><span class="fl">280</span>, em<span class="op">=</span><span class="fl">300</span><span class="op">:</span><span class="fl">320</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] NA NA NA NA</span></span>
<span>  </span>
<span>  <span class="co">#data doesn't exist</span></span>
<span>  <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">100</span><span class="op">:</span><span class="fl">150</span>, em<span class="op">=</span><span class="fl">300</span><span class="op">:</span><span class="fl">320</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] "DATA01" "DATA01" "DATA01" "DATA01"</span></span>
<span>  </span>
<span>  <span class="co">#some data exists, still calculate</span></span>
<span>  <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="fl">100</span><span class="op">:</span><span class="fl">350</span>, em<span class="op">=</span><span class="fl">300</span><span class="op">:</span><span class="fl">320</span>, all<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] "DATA02" "DATA02" "DATA02" "DATA02"</span></span></code></pre></div>
<p>You may also want to flag values below the method detection limit
(MDL) this can be done with: <code><a href="../reference/check_mdl.html">check_eem_mdl()</a></code> and
<code><a href="../reference/check_mdl.html">check_abs_mdl()</a></code>. This is useful to ensure that the blanks
are actually blank and ratio values that are returned are based on
“real” data.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#checking absorbance data</span></span>
<span>  <span class="co">#get mdl </span></span>
<span>    <span class="va">abs_mdl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"eemanalyzeR"</span><span class="op">)</span>, </span>
<span>                                 <span class="st">"abs-mdl.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#data is fully above the MDL so NA is returned </span></span>
<span>    <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="fl">254</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span>    </span>
<span>  <span class="co">#data is fully below the MDL so MDL01 is returned</span></span>
<span>    <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="fl">254</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MDL01"</span></span>
<span>    </span>
<span><span class="co">#checking fluorescence data</span></span>
<span>  <span class="co">#get mdl </span></span>
<span>    <span class="va">eem_mdl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"eemanalyzeR"</span><span class="op">)</span>, </span>
<span>                                 <span class="st">"eem-mdl.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="co">#data is completely above the MDL so NA is returned</span></span>
<span>   <span class="fu"><a href="../reference/check_mdl.html">check_eem_mdl</a></span><span class="op">(</span><span class="va">eemlist</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, mdl <span class="op">=</span> <span class="va">eem_mdl</span>, ex<span class="op">=</span><span class="fl">270</span><span class="op">:</span><span class="fl">280</span>, em<span class="op">=</span><span class="fl">300</span><span class="op">:</span><span class="fl">320</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span>    </span>
<span>  <span class="co">#data is fully below the MDL so MDL01 is returned</span></span>
<span>   <span class="fu"><a href="../reference/check_mdl.html">check_eem_mdl</a></span><span class="op">(</span><span class="va">eemlist</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, mdl <span class="op">=</span> <span class="va">eem_mdl</span>, ex<span class="op">=</span><span class="fl">270</span><span class="op">:</span><span class="fl">280</span>, em<span class="op">=</span><span class="fl">300</span><span class="op">:</span><span class="fl">320</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MDL01"</span></span>
<span></span>
<span>  <span class="co">#some of the data is below the MDL so MDL02 is returned</span></span>
<span>    <span class="va">eemlist</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.000001</span> <span class="co">#set a low value so it spans the MDL in the region for an example</span></span>
<span>    <span class="fu"><a href="../reference/check_mdl.html">check_eem_mdl</a></span><span class="op">(</span><span class="va">eemlist</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, mdl <span class="op">=</span> <span class="va">eem_mdl</span>, ex <span class="op">=</span> <span class="fl">314</span>, em<span class="op">=</span><span class="fl">250</span><span class="op">:</span><span class="fl">262</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MDL02"</span></span></code></pre></div>
<p>If your function generates more than one flag (say a flag for missing
data and an MDL flag) you can use the <code><a href="../reference/dot-combine_flags.html">.combine_flags()</a></code>
function to nicely combine the flags.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">#works with a single set of flags </span></span>
<span>    <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="st">"DATA01"</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DATA01"</span></span>
<span>    <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="st">"MDL01"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MDL01"</span></span>
<span>    <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span>    <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="st">"DATAO1"</span>, <span class="st">"MDL01"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DATAO1_MDL01"</span></span>
<span>    <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="st">"DATA01"</span>, <span class="st">"DATA01"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DATA01"</span></span>
<span>  </span>
<span>  <span class="co">#also works with a vector of flags </span></span>
<span>    <span class="va">flag1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MDL01"</span>, <span class="st">"MDL02"</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="va">flag2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DATA01"</span>, <span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">flag1</span>, <span class="va">flag2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MDL01_DATA01" "MDL02"        NA</span></span>
<span>    </span>
<span>  <span class="co">#if you set MDL to TRUE, it knows it's combining two MDL flags </span></span>
<span>    <span class="co">#so if one is MDL01 and one is MDL02, it will return MDL02, some of the </span></span>
<span>    <span class="co">#data was below the MDL </span></span>
<span>    <span class="co">#this function is useful for indices using ratios</span></span>
<span>    <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="st">"MDL01"</span>, <span class="st">"MDL02"</span>, mdl<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MDL03"</span></span></code></pre></div>
<p>Once we’ve gotten the values and the flags, the data needs to be
formatted in a specific way to input into the <code><a href="../reference/get_indices.html">get_indices()</a></code>
function. To do this we can use the <code><a href="../reference/format_index.html">format_index()</a></code>
function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">ex</span> <span class="op">&lt;-</span> <span class="fl">240</span><span class="op">:</span><span class="fl">260</span></span>
<span>  <span class="va">em</span> <span class="op">&lt;-</span> <span class="fl">300</span><span class="op">:</span><span class="fl">320</span></span>
<span>  <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">ex</span>, <span class="va">em</span>, stat <span class="op">=</span> <span class="st">"max"</span><span class="op">)</span></span>
<span>  <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="va">ex</span>, em<span class="op">=</span><span class="va">em</span>, all<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">index_formatted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="st">"test_index"</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span>  <span class="va">index_formatted</span></span>
<span><span class="co">#&gt;                           sample_name        meta_name      index</span></span>
<span><span class="co">#&gt; 1                 B1S1ExampleBlankSEM     ExampleBlank test_index</span></span>
<span><span class="co">#&gt; 2                B1S2ExampleTeaStdSEM    ExampleTeaStd test_index</span></span>
<span><span class="co">#&gt; 3                B1S3ExampleSampleSEM    ExampleSample test_index</span></span>
<span><span class="co">#&gt; 4 ManualExampleTeaWaterfallPlotSample ManualExampleTea test_index</span></span>
<span><span class="co">#&gt;                         value</span></span>
<span><span class="co">#&gt; 1 0.000532084537187436_DATA02</span></span>
<span><span class="co">#&gt; 2    0.520903992822664_DATA02</span></span>
<span><span class="co">#&gt; 3   0.0851942070835534_DATA02</span></span>
<span><span class="co">#&gt; 4     1.48625281995149_DATA02</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-1">Example 1<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h2>
<p>Alright, now that we’ve reviewed all the helper functions and the
requirements for the custom function let’s do an example. Let’s create a
custom function to calculate some new fluorescence indices presented in
<strong>Zhang et al. 2025:</strong></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">U-SoI</mtext><mo>=</mo><mfrac><mrow><mi>U</mi><msub><mn>1</mn><mrow><mi>e</mi><mi>x</mi><mo>:</mo><mn>245</mn><mo>,</mo><mi>e</mi><mi>m</mi><mo>:</mo><mn>440</mn></mrow></msub></mrow><mrow><mi>U</mi><msub><mn>2</mn><mrow><mi>e</mi><mi>x</mi><mo>:</mo><mn>230</mn><mo>,</mo><mi>e</mi><mi>m</mi><mo>:</mo><mn>260</mn></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex"> \text{U-SoI} =\frac{U1_{ex:245, em:440}}{U2_{ex:230, em:260}}  </annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">A-SoI</mtext><mo>=</mo><mfrac><mrow><mi>A</mi><msub><mn>1</mn><mrow><mi>e</mi><mi>x</mi><mo>:</mo><mn>245</mn><mo>,</mo><mi>e</mi><mi>m</mi><mo>:</mo><mn>325</mn></mrow></msub></mrow><mrow><mi>A</mi><msub><mn>2</mn><mrow><mi>e</mi><mi>x</mi><mo>:</mo><mn>260</mn><mo>,</mo><mi>e</mi><mi>m</mi><mo>:</mo><mn>430</mn></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex"> \text{A-SoI} =\frac{A1_{ex:245, em:325}}{A2_{ex:260, em:430}}  </annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">T-SoI</mtext><mo>=</mo><mfrac><mrow><mi>T</mi><msub><mn>1</mn><mrow><mi>e</mi><mi>x</mi><mo>:</mo><mn>260</mn><mo>,</mo><mi>e</mi><mi>m</mi><mo>:</mo><mn>430</mn></mrow></msub></mrow><mrow><mi>T</mi><msub><mn>2</mn><mrow><mi>e</mi><mi>x</mi><mo>:</mo><mn>285</mn><mo>,</mo><mi>e</mi><mi>m</mi><mo>:</mo><mn>365</mn></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex"> \text{T-SoI} =\frac{T1_{ex:260, em:430}}{T2_{ex:285, em:365}}  </annotation></semantics></math></p>
<p>First let’s turn the different indices into a list of excitation and
emission wavelengths.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zhang_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>USoI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">245</span>,<span class="fl">230</span><span class="op">)</span>, em<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">440</span>,<span class="fl">260</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     ASoI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">245</span>,<span class="fl">260</span><span class="op">)</span>, em<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">325</span>,<span class="fl">430</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     TSoI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">260</span>,<span class="fl">285</span><span class="op">)</span>, em<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">430</span>,<span class="fl">365</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can use the <code><a href="../reference/get_fluorescence.html">get_fluorescence()</a></code> helper function to
calculate the fluorescence for the numerator and denominator of the
ratio. Then we can use the <code><a href="../reference/get_ratios.html">get_ratios()</a></code> helper function to
get the ratio. For a single index this would look like:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eemlist</span> <span class="op">&lt;-</span> <span class="va">example_processed_eems</span></span>
<span><span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">zhang_indices</span><span class="op">$</span><span class="va">TSoI</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">zhang_indices</span><span class="op">$</span><span class="va">TSoI</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">zhang_indices</span><span class="op">$</span><span class="va">TSoI</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">zhang_indices</span><span class="op">$</span><span class="va">TSoI</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "4.93586355290846"  "0.528716173072744" "3.87515734359415" </span></span>
<span><span class="co">#&gt; [4] "0.48620210278511"</span></span></code></pre></div>
<p>To get all the indices let’s use the lapply function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">zhang_indices</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">index_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">zhang_indices</span><span class="op">[[</span><span class="va">index_name</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>While we’re calculating each index, let’s also use the
<code><a href="../reference/flag_missing.html">flag_missing()</a></code> function to see if there’s any data missing.
Since we’re finding the maximum value, we’ll set <code>all</code> to
<code>FALSE</code> so it will report a value if there’s some data. We’ll
also check to see if any of the data is below the MDL, since we have two
discrete values we can use <code><a href="../reference/dot-combine_flags.html">.combine_flags()</a></code> to combine the
returned MDL flags. Lastly, we’ll use the <code><a href="../reference/format_index.html">format_index()</a></code>
function to make sure everything is correctly formatted.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">zhang_indices</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">index_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#get values</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">zhang_indices</span><span class="op">[[</span><span class="va">index_name</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>           <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#get flags</span></span>
<span>    <span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="va">index</span><span class="op">$</span><span class="va">ex</span>, em<span class="op">=</span><span class="va">index</span><span class="op">$</span><span class="va">em</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="fu"><a href="../reference/check_mdl.html">check_eem_mdl</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">eem_mdl</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                               <span class="fu"><a href="../reference/check_mdl.html">check_eem_mdl</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">eem_mdl</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, mdl<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#add sample names and make into data.frame (get index name)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">index_name</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="co">#return res</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p>Now we need to make sure to add in the MDL data so we can use it to
check our values. If the MDL is NULL, we want to have a warning, but
still run.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">qaqc_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"eemanalyzeR"</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="co">#get mdl data</span></span>
<span>  <span class="va">check_eem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">qaqc_dir</span>, <span class="st">"eem-mdl.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#load mdl data or warn</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">check_eem</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"fluorescence MDL is missing, indices will not be checked for MDLs"</span><span class="op">)</span></span>
<span>    <span class="va">eem_mdl</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span><span class="va">eem_mdl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">qaqc_dir</span>, <span class="st">"eem-mdl.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<p>Lastly, we just need to return the results as a list. Since we don’t
have any absorbance data we’ll just make it NA.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>abs_index <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>       eem_index<span class="op">=</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="co">#&gt; $abs_index</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $eem_index</span></span>
<span><span class="co">#&gt;                            sample_name        meta_name index             value</span></span>
<span><span class="co">#&gt; 1                  B1S1ExampleBlankSEM     ExampleBlank  USoI            DATA01</span></span>
<span><span class="co">#&gt; 2                 B1S2ExampleTeaStdSEM    ExampleTeaStd  USoI            DATA01</span></span>
<span><span class="co">#&gt; 3                 B1S3ExampleSampleSEM    ExampleSample  USoI            DATA01</span></span>
<span><span class="co">#&gt; 4  ManualExampleTeaWaterfallPlotSample ManualExampleTea  USoI            DATA01</span></span>
<span><span class="co">#&gt; 5                  B1S1ExampleBlankSEM     ExampleBlank  ASoI      DATA01_MDL03</span></span>
<span><span class="co">#&gt; 6                 B1S2ExampleTeaStdSEM    ExampleTeaStd  ASoI            DATA01</span></span>
<span><span class="co">#&gt; 7                 B1S3ExampleSampleSEM    ExampleSample  ASoI            DATA01</span></span>
<span><span class="co">#&gt; 8  ManualExampleTeaWaterfallPlotSample ManualExampleTea  ASoI            DATA01</span></span>
<span><span class="co">#&gt; 9                  B1S1ExampleBlankSEM     ExampleBlank  TSoI             MDL01</span></span>
<span><span class="co">#&gt; 10                B1S2ExampleTeaStdSEM    ExampleTeaStd  TSoI 0.528716173072744</span></span>
<span><span class="co">#&gt; 11                B1S3ExampleSampleSEM    ExampleSample  TSoI  3.87515734359415</span></span>
<span><span class="co">#&gt; 12 ManualExampleTeaWaterfallPlotSample ManualExampleTea  TSoI  0.48620210278511</span></span></code></pre></div>
<p>Great, that all looks good, now we just need to combine all that code
to a custom function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zhang2025</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">abslist</span>, <span class="va">cuvle</span><span class="op">=</span><span class="fl">1</span>, <span class="va">qaqc_dir</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#making sure eemlist and abslist are correct objects</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu">eemanalyzeR</span><span class="fu">:::</span><span class="fu">.is_eemlist</span><span class="op">(</span><span class="va">eemlist</span><span class="op">)</span>, <span class="fu">eemanalyzeR</span><span class="fu">:::</span><span class="fu">.is_abslist</span><span class="op">(</span><span class="va">abslist</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">cuvle</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">attr</span>, <span class="st">"is_doc_normalized"</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#get mdl data</span></span>
<span>  <span class="va">check_eem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">qaqc_dir</span>, <span class="st">"eem-mdl.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#load mdl data or warn</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">check_eem</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"fluorescence MDL is missing, indices will not be checked for MDLs"</span><span class="op">)</span></span>
<span>    <span class="va">eem_mdl</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span><span class="va">eem_mdl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">qaqc_dir</span>, <span class="st">"eem-mdl.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">#specify indices</span></span>
<span>    <span class="va">zhang_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>USoI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">245</span>,<span class="fl">230</span><span class="op">)</span>, em<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">440</span>,<span class="fl">260</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     ASoI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">245</span>,<span class="fl">260</span><span class="op">)</span>, em<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">325</span>,<span class="fl">430</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     TSoI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">260</span>,<span class="fl">285</span><span class="op">)</span>, em<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">430</span>,<span class="fl">365</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#get results as a data.frame</span></span>
<span>   <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">zhang_indices</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">index_name</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">zhang_indices</span><span class="op">[[</span><span class="va">index_name</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>               <span class="fu"><a href="../reference/get_fluorescence.html">get_fluorescence</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>        </span>
<span>      </span>
<span>      <span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">eemlist</span>, ex<span class="op">=</span><span class="va">index</span><span class="op">$</span><span class="va">ex</span>, em<span class="op">=</span><span class="va">index</span><span class="op">$</span><span class="va">em</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="fu"><a href="../reference/check_mdl.html">check_eem_mdl</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">eem_mdl</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                                   <span class="fu"><a href="../reference/check_mdl.html">check_eem_mdl</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">eem_mdl</span>, <span class="va">index</span><span class="op">$</span><span class="va">ex</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">index</span><span class="op">$</span><span class="va">em</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, mdl<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span>    </span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">index_name</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span>        </span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#combine lists together</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">results</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>abs_index <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>         eem_index<span class="op">=</span><span class="va">results</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now let’s test our custom function with the
<code><a href="../reference/get_indices.html">get_indices()</a></code> function. Note that we get a warning about
the indices because the EEMs data hasn’t gone through any processing
steps.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_indices.html">get_indices</a></span><span class="op">(</span><span class="va">example_processed_eems</span>, </span>
<span>                       <span class="va">example_processed_abs</span>, </span>
<span>                       index_method <span class="op">=</span> <span class="va">zhang2025</span>, </span>
<span>                       return <span class="op">=</span> <span class="st">"wide"</span>, </span>
<span>                       qaqc_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"eemanalyzeR"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">indices</span><span class="op">$</span><span class="va">eem_index</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 5</span></span></span>
<span><span class="co">#&gt;   sample_name                         meta_name        USoI   ASoI         TSoI </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                               <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> B1S1ExampleBlankSEM                 ExampleBlank     DATA01 DATA01_MDL03 MDL01</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> B1S2ExampleTeaStdSEM                ExampleTeaStd    DATA01 DATA01       0.52…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> B1S3ExampleSampleSEM                ExampleSample    DATA01 DATA01       3.875</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ManualExampleTeaWaterfallPlotSample ManualExampleTea DATA01 DATA01       0.48…</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-2">Example 2<a class="anchor" aria-label="anchor" href="#example-2"></a>
</h2>
<p>The last example only used fluorescence data. Let’s create another
custom function focused on absorbance indices. We’ll create a function
to calculate the indices used in <strong>Erlandsson et
al. 2012:</strong></p>
<table class="table">
<thead><tr class="header">
<th align="left">Index</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">a254</td>
<td align="left">absorbance at 254 nm</td>
</tr>
<tr class="even">
<td align="left">a420</td>
<td align="left">absorbance at 420 nm</td>
</tr>
<tr class="odd">
<td align="left">a220_a254</td>
<td align="left">ratio of absorbance at 220 to 254 nm</td>
</tr>
<tr class="even">
<td align="left">a250_a364</td>
<td align="left">ratio of absorbance at 250 to 364 nm</td>
</tr>
<tr class="odd">
<td align="left">a300_a400</td>
<td align="left">ratio of absorbance at 300 to 400 nm</td>
</tr>
<tr class="even">
<td align="left">S275_295</td>
<td align="left">spectral slope between 275 to 295 nm</td>
</tr>
<tr class="odd">
<td align="left">SR</td>
<td align="left">spectral ratio</td>
</tr>
</tbody>
</table>
<p>First let’s turn the indices into a list of wavelengths to help with
flagging and calculating. Note that for the ratios we only need two
specific wavelengths, so we’re making that a vector of just those two
wavelengths, while the spectral slope needs all the wavelengths between
those two values, so we’re making that a vector of all the wavelengths
between those two wavelengths.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">erlandsson_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a254<span class="op">=</span><span class="fl">254</span>,</span>
<span>                         a420<span class="op">=</span><span class="fl">420</span>,</span>
<span>                         a220_a254<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">220</span>,<span class="fl">250</span><span class="op">)</span>,</span>
<span>                         a254_a364<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">254</span>,<span class="fl">364</span><span class="op">)</span>,</span>
<span>                         a300_a400<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">400</span><span class="op">)</span>,</span>
<span>                         S275_295<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span><span class="op">:</span><span class="fl">295</span><span class="op">)</span>,</span>
<span>                         SR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span><span class="op">:</span><span class="fl">295</span>, <span class="fl">350</span><span class="op">:</span><span class="fl">400</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can use the <code><a href="../reference/get_absorbance.html">get_absorbance()</a></code> helper function to
calculate the absorbance at 254 and 420. For a single wavelength that
looks like:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abslist</span> <span class="op">&lt;-</span> <span class="va">example_processed_abs</span></span>
<span><span class="va">a254</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">erlandsson_index</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">a254</span></span>
<span><span class="co">#&gt; [1] "0.00054853647738303" "0.163215306070913"   "0.0806502356009794" </span></span>
<span><span class="co">#&gt; [4] "0.300921250392953"</span></span></code></pre></div>
<p>Let’s use lapply to get the absorbance, add any flags, and format it
correctly. We’ll use <code><a href="https://rdrr.io/r/base/do.call.html" class="external-link">base::do.call()</a></code> to bind all the lists
of indices together.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abs_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">erlandsson_index</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">index_name</span><span class="op">)</span><span class="op">{</span></span>
<span>       <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index_name</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>       <span class="co">#get values</span></span>
<span>       <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">)</span> </span>
<span>       </span>
<span>       <span class="co">#get flags</span></span>
<span>        <span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">)</span></span>
<span>        <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co">#add sample names and make into data.frame (get index name)</span></span>
<span>        <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">index_name</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co">#return res</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>     <span class="op">}</span><span class="op">)</span></span>
<span><span class="va">abs_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">abs_data</span><span class="op">)</span></span></code></pre></div>
<p>Next lets get the ratios, we can still use the
<code><a href="../reference/get_absorbance.html">get_absorbance()</a></code> helper function to get the absorbance at
the wavelengths, and then use the <code><a href="../reference/get_ratios.html">get_ratios()</a></code> helper
function to get the ratio with any flags. In the case below, we don’t
have absorbance at 220 nm, so we get flags of DATA01</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a220</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="fl">220</span><span class="op">)</span> </span>
<span><span class="va">a254</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="fl">254</span><span class="op">)</span></span>
<span><span class="va">a220_a254</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="va">a220</span>, <span class="va">a254</span><span class="op">)</span></span>
<span><span class="va">a220_a254</span></span>
<span><span class="co">#&gt; [1] "DATA01" "DATA01" "DATA01" "DATA01"</span></span></code></pre></div>
<p>Since we’re getting multiple different sets of ratios, let’s use
<code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">base::lapply()</a></code> to get all of the ratios at once.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ratios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">erlandsson_index</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">index_name</span><span class="op">)</span><span class="op">{</span></span>
<span>       <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index_name</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>       <span class="co">#get values</span></span>
<span>       <span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span>       <span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>       <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="va">a1</span>, <span class="va">a2</span><span class="op">)</span></span>
<span>     <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>While we’re calculating each index, let’s also use the
<code><a href="../reference/flag_missing.html">flag_missing()</a></code> function to see if there’s any data missing.
Lastly, we’ll use the <code><a href="../reference/format_index.html">format_index()</a></code> function to make sure
everything is correctly formatted. We’ll use <code>do.call</code> to
bind all the lists of indices together.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ratios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">erlandsson_index</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">index_name</span><span class="op">)</span><span class="op">{</span></span>
<span>       <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index_name</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>       <span class="co">#get values</span></span>
<span>       <span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span>       <span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>       <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="va">a1</span>, <span class="va">a2</span><span class="op">)</span></span>
<span>       </span>
<span>        <span class="co">#get flags</span></span>
<span>        <span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">)</span></span>
<span>        <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co">#add sample names and make into data.frame (get index name)</span></span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">index_name</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span>        </span>
<span>      <span class="co">#return res</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>     <span class="op">}</span><span class="op">)</span></span>
<span><span class="va">ratios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">ratios</span><span class="op">)</span></span></code></pre></div>
<p>Lastly we need to get the spectral slopes and spectral ratio. For
these we’ll use the <code><a href="../reference/get_abs_slope.html">get_abs_slope()</a></code> function.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="st">"S275_295"</span></span>
<span><span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_abs_slope.html">get_abs_slope</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span>,<span class="fl">295</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, mdl<span class="op">=</span><span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span><span class="va">S275_295</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">index</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="st">"SR"</span></span>
<span><span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_abs_slope.html">get_abs_slope</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span>,<span class="fl">295</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="../reference/get_abs_slope.html">get_abs_slope</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">350</span>,<span class="fl">400</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, mdl<span class="op">=</span><span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="fl">275</span><span class="op">:</span><span class="fl">295</span><span class="op">)</span>,</span>
<span>                           <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, mdl<span class="op">=</span><span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="fl">350</span><span class="op">:</span><span class="fl">400</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span><span class="va">SR</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">index</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span></code></pre></div>
<p>Now we need to make sure to add in the MDL data so we can use it to
check our values. If the MDL is NULL, we want to have a warning, but
still run.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">qaqc_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"eemanalyzeR"</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="co">#get mdl data</span></span>
<span>  <span class="va">check_abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">qaqc_dir</span>, <span class="st">"abs-mdl.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#load mdl data or warn</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">check_abs</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"absorbance MDL is missing, indices will not be checked for MDLs"</span><span class="op">)</span></span>
<span>    <span class="va">abs_mdl</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span><span class="va">abs_mdl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">qaqc_dir</span>, <span class="st">"abs-mdl.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<p>Lastly, we just need to combine all the indices into a data.frame and
return the results as a list using another <code><a href="https://rdrr.io/r/base/do.call.html" class="external-link">base::do.call()</a></code>.
Since we don’t have any EEMs data we’ll just make it NA.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">abs_data</span>, <span class="va">ratios</span>, <span class="va">S275_295</span>, <span class="va">SR</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>abs_index <span class="op">=</span> <span class="va">results</span>,</span>
<span>       eem_index<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">#&gt; $abs_index</span></span>
<span><span class="co">#&gt;                         sample_name        meta_name     index</span></span>
<span><span class="co">#&gt; 1               B1S1ExampleBlankABS     ExampleBlank      a254</span></span>
<span><span class="co">#&gt; 2              B1S2ExampleTeaStdABS    ExampleTeaStd      a254</span></span>
<span><span class="co">#&gt; 3              B1S3ExampleSampleABS    ExampleSample      a254</span></span>
<span><span class="co">#&gt; 4  ManualExampleTeaAbsSpectraGraphs ManualExampleTea      a254</span></span>
<span><span class="co">#&gt; 5               B1S1ExampleBlankABS     ExampleBlank      a420</span></span>
<span><span class="co">#&gt; 6              B1S2ExampleTeaStdABS    ExampleTeaStd      a420</span></span>
<span><span class="co">#&gt; 7              B1S3ExampleSampleABS    ExampleSample      a420</span></span>
<span><span class="co">#&gt; 8  ManualExampleTeaAbsSpectraGraphs ManualExampleTea      a420</span></span>
<span><span class="co">#&gt; 9               B1S1ExampleBlankABS     ExampleBlank a220_a254</span></span>
<span><span class="co">#&gt; 10             B1S2ExampleTeaStdABS    ExampleTeaStd a220_a254</span></span>
<span><span class="co">#&gt; 11             B1S3ExampleSampleABS    ExampleSample a220_a254</span></span>
<span><span class="co">#&gt; 12 ManualExampleTeaAbsSpectraGraphs ManualExampleTea a220_a254</span></span>
<span><span class="co">#&gt; 13              B1S1ExampleBlankABS     ExampleBlank a254_a364</span></span>
<span><span class="co">#&gt; 14             B1S2ExampleTeaStdABS    ExampleTeaStd a254_a364</span></span>
<span><span class="co">#&gt; 15             B1S3ExampleSampleABS    ExampleSample a254_a364</span></span>
<span><span class="co">#&gt; 16 ManualExampleTeaAbsSpectraGraphs ManualExampleTea a254_a364</span></span>
<span><span class="co">#&gt; 17              B1S1ExampleBlankABS     ExampleBlank a300_a400</span></span>
<span><span class="co">#&gt; 18             B1S2ExampleTeaStdABS    ExampleTeaStd a300_a400</span></span>
<span><span class="co">#&gt; 19             B1S3ExampleSampleABS    ExampleSample a300_a400</span></span>
<span><span class="co">#&gt; 20 ManualExampleTeaAbsSpectraGraphs ManualExampleTea a300_a400</span></span>
<span><span class="co">#&gt; 21              B1S1ExampleBlankABS     ExampleBlank  S275_295</span></span>
<span><span class="co">#&gt; 22             B1S2ExampleTeaStdABS    ExampleTeaStd  S275_295</span></span>
<span><span class="co">#&gt; 23             B1S3ExampleSampleABS    ExampleSample  S275_295</span></span>
<span><span class="co">#&gt; 24 ManualExampleTeaAbsSpectraGraphs ManualExampleTea  S275_295</span></span>
<span><span class="co">#&gt; 25              B1S1ExampleBlankABS     ExampleBlank        SR</span></span>
<span><span class="co">#&gt; 26             B1S2ExampleTeaStdABS    ExampleTeaStd        SR</span></span>
<span><span class="co">#&gt; 27             B1S3ExampleSampleABS    ExampleSample        SR</span></span>
<span><span class="co">#&gt; 28 ManualExampleTeaAbsSpectraGraphs ManualExampleTea        SR</span></span>
<span><span class="co">#&gt;                 value</span></span>
<span><span class="co">#&gt; 1               MDL01</span></span>
<span><span class="co">#&gt; 2   0.163215306070913</span></span>
<span><span class="co">#&gt; 3  0.0806502356009794</span></span>
<span><span class="co">#&gt; 4   0.300921250392953</span></span>
<span><span class="co">#&gt; 5               MDL01</span></span>
<span><span class="co">#&gt; 6  0.0097782541629343</span></span>
<span><span class="co">#&gt; 7   0.005703926210965</span></span>
<span><span class="co">#&gt; 8  0.0174349110598922</span></span>
<span><span class="co">#&gt; 9        DATA01_MDL01</span></span>
<span><span class="co">#&gt; 10             DATA01</span></span>
<span><span class="co">#&gt; 11             DATA01</span></span>
<span><span class="co">#&gt; 12             DATA01</span></span>
<span><span class="co">#&gt; 13              MDL01</span></span>
<span><span class="co">#&gt; 14   4.30029009047272</span></span>
<span><span class="co">#&gt; 15   5.03597089422996</span></span>
<span><span class="co">#&gt; 16   4.47739151485424</span></span>
<span><span class="co">#&gt; 17              MDL01</span></span>
<span><span class="co">#&gt; 18   6.02242754070733</span></span>
<span><span class="co">#&gt; 19   5.46607410055233</span></span>
<span><span class="co">#&gt; 20   6.50764672772594</span></span>
<span><span class="co">#&gt; 21              MDL01</span></span>
<span><span class="co">#&gt; 22 0.0230618505221762</span></span>
<span><span class="co">#&gt; 23 0.0130236674635653</span></span>
<span><span class="co">#&gt; 24 0.0230606966213098</span></span>
<span><span class="co">#&gt; 25              MDL01</span></span>
<span><span class="co">#&gt; 26   1.03003744636482</span></span>
<span><span class="co">#&gt; 27  0.740240611049655</span></span>
<span><span class="co">#&gt; 28   1.00357361747553</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $eem_index</span></span>
<span><span class="co">#&gt; [1] NA</span></span></code></pre></div>
<p>Great, that all looks good, now we just need to combine all that code
to a custom function.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">erlandsson2012</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">abslist</span>, <span class="va">cuvle</span><span class="op">=</span><span class="fl">1</span>, <span class="va">qaqc_dir</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#making sure eemlist and abslist are correct objects</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu">eemanalyzeR</span><span class="fu">:::</span><span class="fu">.is_eemlist</span><span class="op">(</span><span class="va">eemlist</span><span class="op">)</span>, <span class="fu">eemanalyzeR</span><span class="fu">:::</span><span class="fu">.is_abslist</span><span class="op">(</span><span class="va">abslist</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">cuvle</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">eemlist</span>, <span class="va">attr</span>, <span class="st">"is_doc_normalized"</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#get mdl </span></span>
<span>  <span class="va">check_abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">qaqc_dir</span>, <span class="st">"abs-mdl.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#load mdl data or warn</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="va">check_abs</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"absorbance MDL is missing, indices will not be checked for MDLs"</span><span class="op">)</span></span>
<span>    <span class="va">abs_mdl</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span><span class="va">abs_mdl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">qaqc_dir</span>, <span class="st">"abs-mdl.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">#specify wavelengths</span></span>
<span>    <span class="va">erlandsson_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a254<span class="op">=</span><span class="fl">254</span>,</span>
<span>                         a420<span class="op">=</span><span class="fl">420</span>,</span>
<span>                         a220_a254<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">220</span>,<span class="fl">250</span><span class="op">)</span>,</span>
<span>                         a254_a364<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">254</span>,<span class="fl">364</span><span class="op">)</span>,</span>
<span>                         a300_a400<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">400</span><span class="op">)</span>,</span>
<span>                         S275_295<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span><span class="op">:</span><span class="fl">295</span><span class="op">)</span>,</span>
<span>                         SR<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span><span class="op">:</span><span class="fl">295</span>, <span class="fl">350</span><span class="op">:</span><span class="fl">400</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#get results as a data.frame</span></span>
<span>    <span class="va">abs_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">erlandsson_index</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">index_name</span><span class="op">)</span><span class="op">{</span></span>
<span>       <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index_name</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>       <span class="co">#get values</span></span>
<span>       <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">)</span> </span>
<span>       </span>
<span>       <span class="co">#get flags</span></span>
<span>        <span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">)</span></span>
<span>        <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span>        </span>
<span>      <span class="co">#add sample names and make into data.frame (get index name)</span></span>
<span>        <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">index_name</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co">#return res</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>     <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">abs_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">abs_data</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="va">ratios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">erlandsson_index</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">index_name</span><span class="op">)</span><span class="op">{</span></span>
<span>       <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index_name</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>       <span class="co">#get values</span></span>
<span>       <span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span>       <span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_absorbance.html">get_absorbance</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>       <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="va">a1</span>, <span class="va">a2</span><span class="op">)</span></span>
<span>       </span>
<span>        <span class="co">#get flags</span></span>
<span>        <span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">index</span>, all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="va">index</span><span class="op">)</span></span>
<span>        <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co">#add sample names and make into data.frame (get index name)</span></span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">index_name</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span>        </span>
<span>      <span class="co">#return res</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>     <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">ratios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">ratios</span><span class="op">)</span> </span>
<span>    </span>
<span>    <span class="va">index</span> <span class="op">&lt;-</span> <span class="st">"S275_295"</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_abs_slope.html">get_abs_slope</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span>,<span class="fl">295</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, mdl<span class="op">=</span><span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span>    <span class="va">S275_295</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">index</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">index</span> <span class="op">&lt;-</span> <span class="st">"SR"</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_ratios.html">get_ratios</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_abs_slope.html">get_abs_slope</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">275</span>,<span class="fl">295</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                       <span class="fu"><a href="../reference/get_abs_slope.html">get_abs_slope</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">350</span>,<span class="fl">400</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">missflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_missing.html">flag_missing</a></span><span class="op">(</span><span class="va">abslist</span>, wl<span class="op">=</span><span class="va">erlandsson_index</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">mdlflags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, mdl<span class="op">=</span><span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="fl">275</span><span class="op">:</span><span class="fl">295</span><span class="op">)</span>,</span>
<span>                               <span class="fu"><a href="../reference/check_mdl.html">check_abs_mdl</a></span><span class="op">(</span><span class="va">abslist</span>, mdl<span class="op">=</span><span class="va">abs_mdl</span>, wl<span class="op">=</span><span class="fl">350</span><span class="op">:</span><span class="fl">400</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">flags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-combine_flags.html">.combine_flags</a></span><span class="op">(</span><span class="va">missflags</span>, <span class="va">mdlflags</span><span class="op">)</span></span>
<span>    <span class="va">SR</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_index.html">format_index</a></span><span class="op">(</span><span class="va">abslist</span>, <span class="va">index</span>, <span class="va">vals</span>, <span class="va">flags</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#combine lists together</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">abs_data</span>, <span class="va">ratios</span>, <span class="va">S275_295</span>, <span class="va">SR</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>abs_index <span class="op">=</span> <span class="va">results</span>,</span>
<span>       eem_index<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now let’s test our custom function with the
<code><a href="../reference/get_indices.html">get_indices()</a></code> function. Once again note that we get a
warning about the indices because the EEMs data hasn’t gone through any
processing steps.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_indices.html">get_indices</a></span><span class="op">(</span><span class="va">example_processed_eems</span>, <span class="va">example_processed_abs</span>, index_method <span class="op">=</span> <span class="va">erlandsson2012</span>, </span>
<span>                       qaqc_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"eemanalyzeR"</span><span class="op">)</span><span class="op">)</span>, return<span class="op">=</span><span class="st">"wide"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">indices</span><span class="op">$</span><span class="va">abs_index</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 9</span></span></span>
<span><span class="co">#&gt;   sample_name meta_name a254  a420  a220_a254 a254_a364 a300_a400 S275_295 SR   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> B1S1Exampl… ExampleB… MDL01 MDL01 DATA01_M… MDL01     MDL01     MDL01    MDL01</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> B1S2Exampl… ExampleT… 0.16… 0.00… DATA01    4.3       6.022     0.02306  1.03 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> B1S3Exampl… ExampleS… 0.08… 0.00… DATA01    5.036     5.466     0.01302  0.74…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ManualExam… ManualEx… 0.30… 0.01… DATA01    4.477     6.508     0.02306  1.004</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Zhang, H., Hou, J., Nie, L., Hao, Y., Gao, H., &amp; Yu, H. (2025).
Developing new spectral indices for identifying DOM sources in Liaohe
River in a large-scale river basin by fluorescence spectroscopy and
random forest model. Process Safety and Environmental Protection, 201,
107553. <a href="doi:10.1016/j.psep.2025.107553" class="uri">doi:10.1016/j.psep.2025.107553</a></p>
<p>Erlandsson, M., N. Futter, M., N. Kothawala, D., &amp; J. Köhler, S.
(2012). Variability in spectral absorbance metrics across boreal lake
waters. Journal of Environmental Monitoring, 14(10), 2643-2652. <a href="doi:10.1039/C2EM30266G" class="uri">doi:10.1039/C2EM30266G</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Katie A. Wampler, Ryan P. Cole.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
